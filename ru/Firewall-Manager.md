# Функция управления файрволлом - Руководство пользователя

## Обзор

Функция `firewall_setup` предоставляет интерактивное меню для управления правилами фаервола с использованием `iptables` (цепочка DOCKER-USER) и `ufw`. Особенно полезна в средах Docker, где необходимо управлять сетевым доступом с сохранением совместимости с UFW.

## Возможности

- Двойное управление iptables (цепочка DOCKER-USER) и UFW
- Управление портами (открытие/закрытие/блокировка)
- Управление IP-адресами (разрешение/запрет)
- Просмотр правил и статистики
- Полный сброс правил
- Цветной интерфейс для лучшей видимости

## Первоначальная настройка

Перед работой с функцией запустите установку Sepolia ноды. Затем приступайте к настройке:

1. Сначала запустите **Опцию 1**, чтобы:
    - Проверить/создать цепочку DOCKER-USER
    - Настроить переход FORWARD -> DOCKER-USER
    - Включить и настроить UFW с базовым доступом SSH

2. Затем используйте **Опцию 2 → Блокировка RPC и BEACON портов**, чтобы:
    - Защитить RPC-порты по умолчанию
    - Настроить UFW на блокировку всех входящих соединений

Не забудьте открыть порты, необходимые для работы ноды. Например для Aztec: **8080**,**40400**

## Основные опции меню

### 1. Инициализация системы (`Опция 1`)
- **Что делает**:
    - Проверяет и создает специальную цепочку `DOCKER-USER` в iptables
    - Настраивает интеграцию между цепочками `FORWARD` и `DOCKER-USER`
    - Активирует UFW (Uncomplicated Firewall) с базовыми настройками

- **Когда использовать**:
    - При первом запуске скрипта
    - После переустановки системы
    - При сбросе правил (после опции 5)

- **Важно**: Автоматически разрешает SSH-доступ (порт 22) перед активацией UFW

### 2. Управление портами (`Опция 2`)
#### Открытие портов:
1. Вводите номер порта (или несколько через запятую)
2. Выбираете направление:
    - `1` - Входящие соединения
    - `2` - Исходящие соединения
    - `3` - Оба направления
3. Выбираете протокол:
    - `1` - TCP
    - `2` - UDP
    - `3` - Оба протокола

#### Закрытие портов:
- Три варианта удаления:
    1. Только из iptables
    2. Только из UFW
    3. Из обоих сразу
- Поддержка форматов:
    - Одиночные номера: `5`
    - Списки: `3,7,12`
    - Диапазоны: `10-15`
    - Комбинации: `1,5-8,12`

#### Блокировка RPC-портов:
- Автоматически блокирует стандартные RPC-порты
- Меняет политику UFW на `deny incoming`

### 3. Управление IP-адресами (`Опция 3`)
#### Разрешение доступа:
1. Вводите IP/подсеть (можно несколько через запятую)
2. Опционально указываете порт(ы)
3. Выбираете направление и протокол (аналогично портам)

#### Удаление правил:
- Аналогично удалению правил для портов
- Показывает правила с привязкой к IP перед удалением

### 4. Просмотр правил (`Опция 4`)
- Выводит в удобном формате:
    - Все правила iptables в цепочке DOCKER-USER
    - Все активные правила UFW
    - Статистику по типам правил
    - Текущие политики по умолчанию

### 5. Сброс правил (`Опция 5`)
**Опасная операция** - требует подтверждения:
1. Полностью очищает цепочку DOCKER-USER
2. Сбрасывает все правила UFW
3. Перезапускает Docker-сервис

## Рабочий процесс

1. **Первая настройка**:
    - Всегда начинайте с `Опции 1` (инициализация)
    - Затем настройте нужные порты через `Опцию 2`

2. **Регулярное использование**:
    - Для временного доступа используйте `Опцию 3` (IP-адреса)
    - Для проверки - `Опцию 4` (просмотр правил)

3. **Ошибки/сброс**:
    - При проблемах используйте `Опцию 5` (полный сброс)
    - Повторите инициализацию (`Опция 1`)

## Особенности интерфейса

- **Поддержка прерываний в функциях управления портами и ip-адресами**:
    - Нажатие Ctrl+C и затем Enter на этапе ввода портов или ip-адресов возвращает в предыдущее меню
    - Не прерывает выполнение скрипта

